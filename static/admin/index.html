<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>PINE64 CMS</title>
    <link rel="stylesheet" href="custom.css">
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      CMS.registerPreviewStyle("custom_preview.css");
      CMS.registerPreviewStyle("/css/style.min.css");
      CMS.registerPreviewStyle("/css/documentation.min.css");
    </script>

    <script>

// credits
CMS.registerEditorComponent({
    id: "credits",
    label: "Credits",
    fields: [{
            name: "authors",
            label: "Author(s)",
            widget: "string"
        }
    ],
    pattern: /^{{<\s*credits\s*"(.*?)"\s*>}}/,
    fromBlock: function(match) {
        return {
            authors: match[1]
        };
    },
    toBlock: function(obj) {
        return `{{< credits ${obj.authors} >}}`;
    },
    toPreview: function(obj) {
        return '<i>'+obj.authors+'</i>';
    },
});

// Full docs
CMS.registerEditorComponent({
    id: "fulldocs",
    label: "Full documentation",
    fields: [{
            name: "section",
            label: "Section",
            widget: "string"
        }
    ],
    pattern: /^{{<\s*docs\/onepage\s*section="(.*?)"\s*>}}/,
    fromBlock: function(match) {
        return {
            section: match[1]
        };
    },
    toBlock: function(obj) {
        return `{{< docs/onepage section="${obj.section}" >}}`;
    },
    toPreview: function(obj) {
        return 'Full documentation for: <i>'+obj.section+'</i>';
    },
});
// figure
CMS.registerEditorComponent({
  id: 'figure', // Unique identifier for the component
  label: 'Figure', // Display name in the editor
  fields: [
    {
      name: 'src',
      label: 'Image Source',
      widget: 'string',
      required: true, // src is required
    },
    {
      name: 'alt',
      label: 'Alt Text',
      widget: 'string',
      required: false, // alt is optional
    },
    {
      name: 'link',
      label: 'Link URL',
      widget: 'string',
      required: false, // link is optional
    },
    {
      name: 'caption',
      label: 'Caption',
      widget: 'string',
      required: false, // caption is optional
    },
    {
      name: 'class',
      label: 'CSS Class',
      widget: 'string',
      required: false, // class is optional
    },
    {
      name: 'title',
      label: 'Title',
      widget: 'string',
      required: false, // title is optional
    },
    {
      name: 'width',
      label: 'Width',
      widget: 'string',
      required: false, // width is optional
    },
  ],
  pattern: /^{{<\s*figure\s+src="([^"]+)"\s*(alt="([^"]+)")?\s*(link="([^"]+)")?\s*(caption="([^"]+)")?\s*(class="([^"]+)")?\s*(title="([^"]+)")?\s*(width="([^"]+)")?\s*>\s*}}$/,
  fromBlock: function (match) {
    return {
      src: match[1],
      alt: match[3] || '',
      link: match[5] || '',
      caption: match[7] || '',
      class: match[9] || '',
      title: match[11] || '',
      width: match[13] || '',
    };
  },
  toBlock: function (obj) {
    return `{{< figure src="${obj.src}" alt="${obj.alt}" link="${obj.link}" caption="${obj.caption}" class="${obj.class}" title="${obj.title}" width="${obj.width}" >}}`;
  },
  toPreview: function (obj) {
    return `
      <figure class="${obj.class}">
        <img src="${obj.src}" alt="${obj.alt}" title="${obj.title}" style="${obj.width ? `width: ${obj.width};` : ''}" />
        ${obj.caption ? `<figcaption>${obj.caption}</figcaption>` : ''}
        ${obj.link ? `<a href="${obj.link}">Read more</a>` : ''}
      </figure>
    `;
  },
});
// toc
CMS.registerEditorComponent({
    id: "toc",
    label: "Table of Contents",
    pattern: /^{{<\s*toc\s*>}}/,
    toBlock: function(obj) {
        return `{{< toc >}}`;
    },
    toPreview: function(obj) {
        return '<hr><b>TABLE OF CONTENTS</b><br>Hidden in preview<hr>';
    },
});
// podcast_player
CMS.registerEditorComponent({
    id: "podcast_player",
    label: "Podcast player",
    fields: [
    {
      name: 'episode',
      label: 'Episode',
      widget: 'string',
      required: true, // required
    },
    {
      name: 'direct',
      label: 'Direct file',
      widget: 'string',
      required: true, // required
    }
    ],
    pattern: /^{{<\s*podcast_player\s*episode="(.*?)"\s*direct="(.*?)"\s*>}}/,
    fromBlock: function(match) {
        return {
            episode: match[1],
            direct: match[2]
        };
    },
    toBlock: function(obj) {
        return `{{< podcast_player episode="${obj.episode}" direct="${obj.direct}"  >}}`;
    },
    toPreview: function(obj) {
        return '<audio controls src="/podcast/episodes/'+obj.direct+'"></audio>';
    },
});

// Youtube
CMS.registerEditorComponent({
    id: "youtube",
    label: "Youtube",
    fields: [{
            name: "id",
            label: "ID",
            widget: "string"
        }
    ],
    pattern: /^{{<\s*youtube\s*id="(.*?)"\s*>}}/,
    fromBlock: function(match) {
        return {
            id: match[1]
        };
    },
    toBlock: function(obj) {
        return `{{< youtube ${obj.id} >}}`;
    },
    toPreview: function(obj) {
        return '<b>[Youtube player:]&nbsp;</b><a href="https://www.youtube.com/watch?v='+obj.id+'"><img src="/blog/images/yt_preview/'+obj.id+'.png" width="200"></a>';
    },
});

// Children
CMS.registerEditorComponent({
    id: "children",
    label: "Children",
    pattern: /^{{<\s*children\s*>}}/,
    toBlock: function() {
        return `{{< children >}}`;
    },
    toPreview: function() {
        return '<hr><b>Child pages are displayed here</b><hr>';
    },
});

// Device boxes
CMS.registerEditorComponent({
  id: 'flexbox',
  label: 'Flexbox',
  pattern: /{{<\s*flexbox\s*>}}([\s\S]*?){{<\s*\/\s*flexbox\s*>}}/m,

  fromBlock: function(match) {
    const inner = match[1].trim();
    const boxRE = /{{<\s*devices\/device_box\s+([^>]+)\s*>}}/g;
    let m, boxes = [];

    while ((m = boxRE.exec(inner)) !== null) {
      const attrs = {};
      m[1].match(/(\w+)="([^"]*)"/g).forEach(pair => {
        const [key, val] = pair.split('=');
        attrs[key] = val.replace(/^"|"$/g, '');
      });
      boxes.push({
        link: attrs.link,
        img: attrs.img,
        title: attrs.title,
        text: attrs.text || ''
      });
    }

    return { boxes };
  },

  toBlock: function(data) {
    let out = '{{< flexbox >}}\n';
    data.boxes.forEach(b => {
      const txt = (b.text || '').replace(/\n/g, '\\n');
      out += `  {{< devices/device_box link="${b.link}" img="${b.img}" title="${b.title}" text="${txt}" >}}\n`;
    });
    out += '{{</ flexbox >}}';
    return out;
  },

  toPreview: function(data) {
    const wrapperStyle = 
      'display:flex;flex-wrap:wrap;gap:10px;border:1px dashed #ddd;padding:10px;';
    const itemStyle = 
      'flex:1 1 200px;box-sizing:border-box;border:1px solid #ccc;padding:8px;';
    const html = data.boxes.map(b => {
      return `
        <div style="${itemStyle}">
          <a href="${b.link}" style="text-decoration:none;color:inherit;">
            <img 
              src="${b.img}" 
              alt="${b.title}" 
              style="max-width:100%;height:auto;display:block;margin-bottom:8px;"
            />
            <h4 style="margin:0 0 4px;font-size:1em;">${b.title}</h4>
            <p style="margin:0;font-size:0.9em;color:#555;">
              ${b.text || ''}
            </p>
          </a>
        </div>`;
    }).join('');
    return `<div style="${wrapperStyle}">${html}</div>`;
  },

  fields: [
    {
      label: 'Device Boxes',
      name: 'boxes',
      widget: 'list',
      summary: '{{title}} ({{link}})',
      fields: [
        { label: 'Link',  name: 'link',  widget: 'string' },
        { label: 'Image', name: 'img',   widget: 'image'  },
        { label: 'Title', name: 'title', widget: 'string' },
        { label: 'Text',  name: 'text',  widget: 'text',   default: '' }
      ]
    }
  ]
});

// Figure
CMS.registerEditorComponent({
  id: 'figure',
  label: 'Figure',
  pattern: /{{<\s*figure\s+([^>]+?)\s*>}}/,

  fromBlock: function(match) {
    const attrs = {};
    match[1].match(/(\w+)="([^"]*?)"/g).forEach(pair => {
      const [key, val] = pair.split('=');
      attrs[key] = val.replace(/^"|"$/g, '');
    });
    return {
      src: attrs.src || '',
      caption: attrs.caption || '',
      width: attrs.width || ''
    };
  },

  toBlock: function(data) {
    const src     = data.src     || '';
    const caption = data.caption || '';
    const width   = data.width   || '';
    return `{{< figure src="${src}" caption="${caption}" width="${width}" >}}`;
  },

  toPreview: function(data) {
    const w = data.width ? `width:${data.width}px;` : '';
    return `
      <figure style="margin:0;${w}">
        <img src="${data.src}" style="max-width:100%;height:auto;display:block;" />
        <figcaption style="font-size:0.9em;color:#666;margin-top:4px;">
          ${data.caption}
        </figcaption>
      </figure>
    `;
  },

  fields: [
    {
      label: 'Image',
      name: 'src',
      widget: 'image'
    },
    {
      label: 'Caption',
      name: 'caption',
      widget: 'string'
    },
    {
      label: 'Width (px)',
      name: 'width',
      widget: 'number',
      default: 400
    }
  ]
});

// Admonitions
CMS.registerEditorComponent({
  id: "admonition",
  label: "Admonition",
  fields: [
    {
      name: "type",
      label: "Admonition Type",
      widget: "select",
      options: [
        { label: "Note", value: "note" },
        { label: "Tip", value: "tip" },
        { label: "Warning", value: "warning" },
        { label: "Caution", value: "caution" },
        { label: "Important", value: "important" }
      ],
      default: "note"
    },
    {
      name: "body",
      label: "Content",
      widget: "markdown",
      default: "",
    },
  ],

  pattern:
    /^{{<\s*admonition\s+type="([^"]+)"\s*>}}\s*([\s\S]*?)\s*{{<\s*\/\s*admonition\s*>}}$/m,

  fromBlock(match) {
    return { type: match[1], body: match[2].trim() };
  },

  toBlock(obj) {
    return [
      `{{< admonition type="${obj.type}" >}}`,
      obj.body,
      `{{< /admonition >}}`,
    ].join("\n");
  },

  toPreview: function(obj) {
    const title = obj.type.charAt(0).toUpperCase() + obj.type.slice(1);
    return `
<div class="admonition admonition-${obj.type}">
    <div class="admonition-header">${title}</div>
    <div class="admonition-text">
        ${obj.body}
    </div>
</div>
    `;
  },
});

// HR
CMS.registerEditorComponent({
  id: "horizontal-rule",
  label: "Horizontal Rule",
  fields: [],
  pattern: /^---$/m,
  fromBlock: () => ({}),
  toBlock: () => '---',
  toPreview: () => '<hr />'
});

    </script>
  </body>
</html>